from agents.base_agent import BaseAgent

class NetPentester(BaseAgent):
    """Specialist for network-layer reconnaissance and exploitation."""
    
    def __init__(self):
        super().__init__("Network Pentester", "Logic for Nmap, Metasploit, and network services.")

    def _get_local_subnet(self):
        """Discovers the local subnet of the machine."""
        res = self.run_cmd("ip addr")
        if res.get("code") != 0:
            return None
        
        stdout = res.get("stdout", "")
        for line in stdout.split("\n"):
            line = line.strip()
            if "inet " in line and "127.0.0.1" not in line:
                # Example: inet 192.168.29.166/24 brd 192.168.29.255 scope global dynamic noprefixroute wlan0
                parts = line.split()
                for p in parts:
                    if "/" in p:
                        # Extract the subnet (e.g., 192.168.29.0/24)
                        ip_prefix = p.split("/")[0]
                        mask = p.split("/")[1]
                        octets = ip_prefix.split(".")
                        octets[-1] = "0"
                        return ".".join(octets) + "/" + mask
        return None

    def execute(self, task):
        # 1. ENHANCE TASK WITH LOCAL CONTEXT
        enhanced_task = task
        if "localnetwork" in task.lower().replace(" ", ""):
            subnet = self._get_local_subnet()
            if subnet:
                enhanced_task += f" (Note: Detected local subnet is {subnet})"
            else:
                enhanced_task += " (Note: Could not automatically detect local subnet)"

        # 2. ANALYZE TASK
        prompt = f"""
        Task: {enhanced_task}
        
        Available Tools: nmap, masscan, netcat, metasploit (msfconsole -x), enum4linux, smbclient, snmpwalk.
        Network Services: SSH, FTP, SMB, SNMP, HTTP, DNS, RDP, Telnet.
        
        Determine the best command to run for network reconnaissance or exploitation.
        Output ONLY the command or [COMPLETE] if the objective is met.
        
        Examples:
        - Port scan: nmap -sV -sC -p- <target>
        - SMB enumeration: enum4linux -a <target>
        - Service banner grab: nc -nv <target> <port>
        """
        decision = self.reason(prompt)
        
        if "[COMPLETE]" in decision.upper():
            return {"status": "complete", "summary": decision}

        # 3. RUN COMMAND
        cmd = decision.strip().replace("`", "").split("\n")[0]  # Clean LLM artifacts
        result = self.run_cmd(cmd)
        
        # 4. SUMMARIZE
        summary = self.summarize_result(cmd, result)
        return {
            "status": "success" if result.get("code") == 0 else "failed",
            "cmd": cmd,
            "stdout": result.get("stdout"),
            "stderr": result.get("stderr"),
            "summary": summary
        }
